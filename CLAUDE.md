# Claude Code Context

Shell scripts for n8n to orchestrate Claude Code sessions remotely using git worktrees.

## Architecture

- `bin/` - Executable entry points called by n8n
- `lib/` - Shared shell libraries (source these, don't execute directly)
- `config/prompts/` - System prompts appended to Claude sessions
- `.env` - Configuration (ROOT_DIR, DEFAULT_SOURCE_BRANCH)

## Key Design Decisions

1. **JSON only to stdout** - n8n parses stdout as JSON; errors also in JSON, not stderr
2. **Text-only questions** - Claude uses `AWAITING_USER_INPUT: true` marker (parsed into JSON response)
3. **Session persistence** - Uses `--session-id` for new sessions, `--resume` for continuations
4. **Branch naming** - `feature/BRANCH_NAME` format
5. **Auto-detect continuation** - If worktree directory exists, it's a continuation; otherwise new session
6. **Git worktrees** - Uses worktrees from pre-existing local repos instead of cloning
7. **Path convention** - Worktrees at `ROOT_DIR/{org}/agents/{repo-name}/{branch-name}`

## Arguments (main.sh)

| Position | Name | Description |
|----------|------|-------------|
| $1 | CHAT_ID | UUID for the session (generated by n8n) |
| $2 | REPO_RELATIVE_PATH | Path relative to ROOT_DIR (e.g., Benji/react-app) |
| $3 | BRANCH_NAME | Branch identifier (e.g., BP25-123) |
| $4 | SOURCE_BRANCH | Branch to create feature from (default from .env) |
| $5 | PROMPT | **Base64-encoded** task description or user response |

## Configuration (.env)

```bash
ROOT_DIR=/path/to/repos           # Base directory for all repositories
DEFAULT_SOURCE_BRANCH=main        # Default source branch
```

## Adding New Scripts

1. Create entry point in `bin/`
2. Source libraries: `source "${LIB_DIR}/common.sh"` etc.
3. Use `load_env` then `parse_args` for argument handling
4. Use `output_success` / `output_error` for JSON output
5. Create corresponding prompt in `config/prompts/`

## Testing

```bash
# Test validation (should error with missing params)
./bin/main.sh

# Test new session
PROMPT=$(echo "Add user authentication feature" | base64)
DEBUG=true ./bin/main.sh \
  "550e8400-e29b-41d4-a716-446655440000" \
  "Benji/react-app" \
  "BP25-123" \
  "develop" \
  "$PROMPT"

# Test continuation (run again with same BRANCH_NAME)
PROMPT=$(echo "Use JWT tokens for the authentication" | base64)
DEBUG=true ./bin/main.sh \
  "550e8400-e29b-41d4-a716-446655440000" \
  "Benji/react-app" \
  "BP25-123" \
  "develop" \
  "$PROMPT"
```

## Output JSON

Success:
```json
{
  "status": "success",
  "chat_id": "...",
  "branch_name": "feature/...",
  "working_dir": "/path/to/repos/Benji/agents/react-app/BP25-123",
  "awaiting_user_input": true|false,
  "claude_response": {...}
}
```

Error:
```json
{
  "status": "error",
  "error_code": 1,
  "error_message": "Missing required parameter: CHAT_ID",
  "chat_id": null,
  "branch_name": null,
  "working_dir": null
}
```

## Exit Codes

- 0: Success
- 1: Invalid parameters
- 2: Git operation failed
- 3: Claude execution failed
- 4: File/directory not found
