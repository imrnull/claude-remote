# Claude Code Context

Shell scripts for n8n to orchestrate Claude Code sessions remotely.

## Architecture

- `bin/` - Executable entry points called by n8n
- `lib/` - Shared shell libraries (source these, don't execute directly)
- `config/prompts/` - System prompts appended to Claude sessions

## Key Design Decisions

1. **JSON only to stdout** - n8n parses stdout as JSON; errors also in JSON, not stderr
2. **Text-only questions** - Claude uses `AWAITING_USER_INPUT: true` marker (parsed into JSON response)
3. **Session persistence** - Uses `--session-id` for new sessions, `--resume` for continuations
4. **Branch naming** - `feature/BRANCH_NAME` format
5. **Auto-detect continuation** - If working directory exists, it's a continuation; otherwise new session

## Arguments (benji-init.sh)

| Position | Name | Description |
|----------|------|-------------|
| $1 | CHAT_ID | UUID for the session (generated by n8n) |
| $2 | REPO_URL | SSH git URL (e.g., git@github.com:org/repo.git) |
| $3 | WORK_BASE_DIR | Base directory for working directories |
| $4 | BRANCH_NAME | Branch identifier (e.g., BP25-123 or add-search-filter) |
| $5 | COMMIT_PREFIX | Prefix for commits (e.g., "BP25-123 - ") or empty |
| $6 | PROMPT | Task description or user response |

## Adding New Scripts

1. Create entry point in `bin/`
2. Source libraries: `source "${LIB_DIR}/common.sh"` etc.
3. Use `parse_args` for argument handling
4. Use `output_success` / `output_error` for JSON output
5. Create corresponding prompt in `config/prompts/`

## Testing

```bash
# Test validation (should error with missing params)
./bin/benji-init.sh

# Test new session
DEBUG=true ./bin/benji-init.sh \
  "550e8400-e29b-41d4-a716-446655440000" \
  "git@github.com:test/repo.git" \
  "/tmp" \
  "BP25-123" \
  "BP25-123 - " \
  "Add user authentication feature"

# Test continuation (run again with same BRANCH_NAME after initial run)
DEBUG=true ./bin/benji-init.sh \
  "550e8400-e29b-41d4-a716-446655440000" \
  "git@github.com:test/repo.git" \
  "/tmp" \
  "BP25-123" \
  "BP25-123 - " \
  "Use JWT tokens for the authentication"
```

## Output JSON

Success:
```json
{
  "status": "success",
  "chat_id": "...",
  "branch_name": "feature/...",
  "working_dir": "/path/...",
  "awaiting_user_input": true|false,
  "claude_response": {...}
}
```

Error:
```json
{
  "status": "error",
  "error_code": 1,
  "error_message": "Missing required parameter: CHAT_ID",
  "chat_id": null,
  "branch_name": null,
  "working_dir": null
}
```

## Exit Codes

- 0: Success
- 1: Invalid parameters
- 2: Git operation failed
- 3: Claude execution failed
- 4: File/directory not found
