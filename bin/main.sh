#!/usr/bin/env bash
# benji-init.sh - Initialize or continue a Benji coding session
#
# Usage:
#   benji-init.sh CHAT_ID REPO_URL WORK_BASE_DIR BRANCH_NAME COMMIT_PREFIX PROMPT [SOURCE_BRANCH]
#
# Arguments:
#   CHAT_ID       - UUID for the Claude session (generated by n8n)
#   REPO_URL      - SSH git URL (e.g., git@github.com:org/repo.git)
#   WORK_BASE_DIR - Base directory for working directories
#   BRANCH_NAME   - Branch identifier (e.g., BP25-123 or add-search-filter)
#   COMMIT_PREFIX - Prefix for commits (e.g., "BP25-123 - ") or empty string
#   PROMPT        - Task description (new session) or response (continuation)
#   SOURCE_BRANCH - Branch to create feature from (default: main)
#
# Behavior:
#   - Working directory: WORK_BASE_DIR/BRANCH_NAME/
#   - If folder doesn't exist: clone repo, create branch feature/BRANCH_NAME
#   - If folder exists: treat as continuation
#
# Exit codes:
#   0 - Success
#   1 - Invalid parameters
#   2 - Git operation failed
#   3 - Claude execution failed
#   4 - File/directory not found

set -euo pipefail

# Get script directory and load libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"
CONFIG_DIR="${SCRIPT_DIR}/../config"

# Source all library files
source "${LIB_DIR}/common.sh"
source "${LIB_DIR}/git-operations.sh"
source "${LIB_DIR}/claude-session.sh"
source "${LIB_DIR}/output.sh"

# Main function
main() {
    local working_dir=""
    local branch_name=""
    local claude_output=""
    local is_continuation=false

    # Parse and validate arguments
    if ! parse_args "$@"; then
        output_error "$EXIT_INVALID_PARAMS" "${PARSE_ERROR:-Invalid parameters}"
        exit $EXIT_INVALID_PARAMS
    fi

    # Validate work base directory exists
    if ! validate_directory "$WORK_BASE_DIR"; then
        output_error "$EXIT_NOT_FOUND" "Work base directory not found: $WORK_BASE_DIR"
        exit $EXIT_NOT_FOUND
    fi

    # Build working directory path
    working_dir="${WORK_BASE_DIR}/${BRANCH_NAME}"
    branch_name=$(generate_feature_branch_name "$BRANCH_NAME")

    if [[ -d "$working_dir" ]]; then
        # Continuation flow - folder exists
        is_continuation=true
        log_info "Continuing session in existing directory: $working_dir"

        # Verify it's a git repo
        if ! git_is_repo "$working_dir"; then
            output_error "$EXIT_GIT_FAILED" "Directory exists but is not a git repository: $working_dir" "$CHAT_ID" "$branch_name" "$working_dir"
            exit $EXIT_GIT_FAILED
        fi

        # Resume Claude session
        if ! claude_output=$(resume_claude_session "$CHAT_ID" "$working_dir" "$PROMPT"); then
            log_debug "Claude returned non-zero exit code"
        fi

    else
        # New session flow - folder doesn't exist
        log_info "Starting new session, creating directory: $working_dir"

        # Clone the repository
        if ! git_clone_repo "$REPO_URL" "$working_dir"; then
            output_error "$EXIT_GIT_FAILED" "Failed to clone repository" "$CHAT_ID" "$branch_name" "$working_dir"
            exit $EXIT_GIT_FAILED
        fi

        # Checkout source branch
        if ! git_checkout_branch "$working_dir" "$SOURCE_BRANCH"; then
            output_error "$EXIT_GIT_FAILED" "Failed to checkout source branch: $SOURCE_BRANCH" "$CHAT_ID" "$branch_name" "$working_dir"
            exit $EXIT_GIT_FAILED
        fi

        # Create feature branch
        if ! git_create_branch "$working_dir" "$branch_name"; then
            output_error "$EXIT_GIT_FAILED" "Failed to create branch" "$CHAT_ID" "$branch_name" "$working_dir"
            exit $EXIT_GIT_FAILED
        fi

        # Build initial prompt
        local initial_prompt="Task: ${PROMPT}

Explore the repository and ask clarifying questions."
        local system_prompt_file="${CONFIG_DIR}/prompts/benji-init.txt"

        # Run Claude with new session
        if ! claude_output=$(run_claude_new_session "$CHAT_ID" "$working_dir" "$initial_prompt" "$system_prompt_file" "$COMMIT_PREFIX"); then
            log_debug "Claude returned non-zero exit code"
        fi
    fi

    # Ensure we have valid JSON output
    claude_output=$(wrap_claude_output "$claude_output")

    # Output success response
    output_success "$CHAT_ID" "$branch_name" "$working_dir" "$claude_output"
}

# Run main function
main "$@"
