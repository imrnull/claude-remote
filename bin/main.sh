#!/usr/bin/env bash
# main.sh - Initialize or continue a Claude Code session using git worktrees
#
# Usage:
#   main.sh CHAT_ID REPO_RELATIVE_PATH BRANCH_NAME SOURCE_BRANCH PROMPT_BASE64
#
# Arguments:
#   CHAT_ID            - UUID for the Claude session (generated by n8n)
#   REPO_RELATIVE_PATH - Path relative to ROOT_DIR (e.g., Benji/react-app)
#   BRANCH_NAME        - Branch identifier (e.g., BP25-123 or add-search-filter)
#   SOURCE_BRANCH      - Branch to create feature from (default from .env)
#   PROMPT_BASE64      - Base64-encoded task description (new) or response (continuation)
#
# Configuration (.env):
#   ROOT_DIR               - Base directory for all repositories
#   DEFAULT_SOURCE_BRANCH  - Default source branch (default: main)
#
# Path derivation (from REPO_RELATIVE_PATH = "Benji/react-app"):
#   Main repo:  ROOT_DIR/Benji/react-app (must exist)
#   Worktree:   ROOT_DIR/Benji/agents/react-app/BRANCH_NAME
#
# COMMIT_PREFIX is auto-derived: "BRANCH_NAME - "
#
# Behavior:
#   - If worktree doesn't exist: create worktree, start new Claude session
#   - If worktree exists: treat as continuation, resume Claude session
#
# Exit codes:
#   0 - Success
#   1 - Invalid parameters
#   2 - Git operation failed
#   3 - Claude execution failed
#   4 - File/directory not found

set -euo pipefail

# Ensure claude CLI is in PATH
export PATH="$HOME/.local/bin:$PATH"
export CLAUDE_CONFIG_DIR="$HOME/.claude"


# Get script directory and load libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"
CONFIG_DIR="${SCRIPT_DIR}/../config"

# Source all library files
source "${LIB_DIR}/common.sh"
source "${LIB_DIR}/git-operations.sh"
source "${LIB_DIR}/claude-session.sh"
source "${LIB_DIR}/output.sh"

# Main function
main() {
    local working_dir=""
    local branch_name=""
    local claude_output=""
    local is_continuation=false

    # Load .env configuration
    if ! load_env; then
        output_error "$EXIT_NOT_FOUND" "${PARSE_ERROR:-.env configuration error}"
        exit $EXIT_NOT_FOUND
    fi

    # Parse and validate arguments
    if ! parse_args "$@"; then
        output_error "$EXIT_INVALID_PARAMS" "${PARSE_ERROR:-Invalid parameters}"
        exit $EXIT_INVALID_PARAMS
    fi

    # Derived paths are set by parse_args
    working_dir="$WORKTREE_DIR"
    branch_name=$(generate_feature_branch_name "$BRANCH_NAME")

    if [[ -d "$working_dir" ]]; then
        # Continuation flow - worktree exists
        is_continuation=true
        log_info "Continuing session in existing worktree: $working_dir"

        # Verify it's a git repo
        if ! git_is_repo "$working_dir"; then
            output_error "$EXIT_GIT_FAILED" "Directory exists but is not a git repository: $working_dir" "$CHAT_ID" "$branch_name" "$working_dir"
            exit $EXIT_GIT_FAILED
        fi

        # Resume Claude session
        if ! claude_output=$(resume_claude_session "$CHAT_ID" "$working_dir" "$PROMPT"); then
            log_debug "Claude returned non-zero exit code"
        fi

    else
        # New session flow - create worktree
        log_info "Starting new session, creating worktree: $working_dir"

        # Create worktree with feature branch
        if ! git_create_worktree "$MAIN_REPO_DIR" "$working_dir" "$branch_name" "$SOURCE_BRANCH"; then
            output_error "$EXIT_GIT_FAILED" "Failed to create worktree" "$CHAT_ID" "$branch_name" "$working_dir"
            exit $EXIT_GIT_FAILED
        fi

        # Save chat ID for manual resume: claude --resume $(cat .CLAUDE_CHAT_ID)
        echo "$CHAT_ID" > "${working_dir}/.CLAUDE_CHAT_ID"

        # Build initial prompt
        local initial_prompt="Task: ${PROMPT}

Explore the repository and ask clarifying questions."
        local system_prompt_file="${CONFIG_DIR}/prompts/main.txt"

        # Run Claude with new session
        if ! claude_output=$(run_claude_new_session "$CHAT_ID" "$working_dir" "$initial_prompt" "$system_prompt_file" "$COMMIT_PREFIX"); then
            log_debug "Claude returned non-zero exit code"
        fi
    fi

    # Ensure we have valid JSON output
    claude_output=$(wrap_claude_output "$claude_output")

    # Output success response
    output_success "$CHAT_ID" "$branch_name" "$working_dir" "$claude_output"
}

# Run main function
main "$@"
