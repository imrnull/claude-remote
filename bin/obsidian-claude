#!/usr/bin/env bash
# obsidian-claude - Initialize or continue a Claude Code session in an Obsidian vault
#
# Usage:
#   obsidian-claude CHAT_ID VAULT_NAME PROMPT_BASE64
#
# Arguments:
#   CHAT_ID       - UUID for the Claude session (generated by n8n)
#   VAULT_NAME    - Obsidian vault name (e.g., Personal, Benji)
#   PROMPT_BASE64 - Base64-encoded task description (new) or response (continuation)
#
# Configuration (.env):
#   OBSIDIAN_VAULTS_DIR - Base directory containing all Obsidian vaults
#
# Behavior:
#   - If Chats/{uuid}.md exists: continuation, resume Claude session
#   - If not: new session, create skeleton chat note, start Claude session
#
# Exit codes:
#   0 - Success
#   1 - Invalid parameters
#   3 - Claude execution failed
#   4 - File/directory not found

set -euo pipefail

# Ensure claude CLI is in PATH
export PATH="$HOME/.local/bin:$PATH"
export CLAUDE_CONFIG_DIR="$HOME/.claude"

# Get script directory and load libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"
CONFIG_DIR="${SCRIPT_DIR}/../config"

# Source library files
source "${LIB_DIR}/common.sh"
source "${LIB_DIR}/claude-session.sh"
source "${LIB_DIR}/output.sh"
source "${LIB_DIR}/obsidian.sh"

# Build system prompt replacing {{NOTE_PATH}} placeholder
# Arguments: template_file, note_path
build_obsidian_system_prompt() {
    local template_file="$1"
    local note_path="$2"

    if [[ ! -f "$template_file" ]]; then
        log_debug "System prompt template not found: $template_file"
        return 1
    fi

    local template
    template=$(cat "$template_file")

    echo "${template//\{\{NOTE_PATH\}\}/$note_path}"
}

# Main function
main() {
    local claude_output=""

    # Load .env configuration
    if ! load_env; then
        output_obsidian_error "$EXIT_NOT_FOUND" "${PARSE_ERROR:-.env configuration error}"
        exit $EXIT_NOT_FOUND
    fi

    # Parse and validate arguments
    if ! parse_obsidian_args "$@"; then
        output_obsidian_error "$EXIT_INVALID_PARAMS" "${PARSE_ERROR:-Invalid parameters}"
        exit $EXIT_INVALID_PARAMS
    fi

    if note_exists "$NOTE_PATH"; then
        # Continuation flow - chat note exists
        log_info "Continuing session for chat note: $NOTE_PATH"

        # Resume Claude session
        if ! claude_output=$(resume_claude_session "$CHAT_ID" "$OBSIDIAN_VAULT_DIR" "$PROMPT"); then
            log_debug "Claude returned non-zero exit code"
        fi

    else
        # New session flow
        log_info "Starting new Obsidian session in vault: $VAULT_NAME"

        # Create Chats directory and skeleton note
        ensure_chats_dir "$CHATS_DIR"
        create_skeleton_note "$NOTE_PATH" "$CHAT_ID"

        # Build initial prompt
        local initial_prompt="Task: ${PROMPT}

Explore the vault and ask clarifying questions."

        # Pre-process system prompt template (replace {{NOTE_PATH}})
        local system_prompt_template="${CONFIG_DIR}/prompts/obsidian.txt"
        local system_prompt_file
        system_prompt_file=$(mktemp)
        build_obsidian_system_prompt "$system_prompt_template" "$NOTE_PATH" > "$system_prompt_file"

        # Run Claude with new session (empty commit_prefix â€” not a git repo)
        if ! claude_output=$(run_claude_new_session "$CHAT_ID" "$OBSIDIAN_VAULT_DIR" "$initial_prompt" "$system_prompt_file" ""); then
            log_debug "Claude returned non-zero exit code"
        fi

        rm -f "$system_prompt_file"
    fi

    # Ensure we have valid JSON output
    claude_output=$(wrap_claude_output "$claude_output")

    # Output success response
    output_obsidian_success "$CHAT_ID" "$NOTE_PATH" "$OBSIDIAN_VAULT_DIR" "$claude_output"
}

# Run main function
main "$@"
