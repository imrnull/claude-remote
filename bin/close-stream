#!/usr/bin/env bash
# close-stream - Push, merge, and remove a git worktree for a Claude Code session
#
# Usage:
#   close-stream REPO_RELATIVE_PATH BRANCH_NAME TARGET_BRANCH
#
# Arguments:
#   REPO_RELATIVE_PATH - Path relative to ROOT_DIR (e.g., Benji/react-app)
#   BRANCH_NAME        - Branch identifier (e.g., BP25-123)
#   TARGET_BRANCH      - Branch to merge into (e.g., main, develop)
#
# Exit codes:
#   0 - Success
#   1 - Invalid parameters
#   2 - Git operation failed
#   4 - File/directory not found

set -euo pipefail

# Get script directory and load libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

source "${LIB_DIR}/common.sh"
source "${LIB_DIR}/git-operations.sh"
source "${LIB_DIR}/output.sh"

# Parse arguments for close-stream
# Sets: REPO_RELATIVE_PATH, BRANCH_NAME, TARGET_BRANCH, MAIN_REPO_DIR, WORKTREE_DIR
parse_close_args() {
    REPO_RELATIVE_PATH="${1:-}"
    BRANCH_NAME="${2:-}"
    TARGET_BRANCH="${3:-}"
    PARSE_ERROR=""

    if ! validate_required "REPO_RELATIVE_PATH" "$REPO_RELATIVE_PATH"; then
        PARSE_ERROR="Missing required parameter: REPO_RELATIVE_PATH"
        return $EXIT_INVALID_PARAMS
    fi
    if ! validate_required "BRANCH_NAME" "$BRANCH_NAME"; then
        PARSE_ERROR="Missing required parameter: BRANCH_NAME"
        return $EXIT_INVALID_PARAMS
    fi
    if ! validate_required "TARGET_BRANCH" "$TARGET_BRANCH"; then
        PARSE_ERROR="Missing required parameter: TARGET_BRANCH"
        return $EXIT_INVALID_PARAMS
    fi

    if ! validate_repo_relative_path "$REPO_RELATIVE_PATH"; then
        PARSE_ERROR="Invalid REPO_RELATIVE_PATH: must be in 'org/repo' format (e.g., Benji/react-app)"
        return $EXIT_INVALID_PARAMS
    fi
    if ! validate_branch_name "$BRANCH_NAME"; then
        PARSE_ERROR="Invalid branch name: BRANCH_NAME (use alphanumeric, hyphens, underscores only)"
        return $EXIT_INVALID_PARAMS
    fi

    derive_repo_paths "$REPO_RELATIVE_PATH"
    WORKTREE_DIR=$(derive_worktree_path "$REPO_RELATIVE_PATH" "$BRANCH_NAME")

    if [[ ! -d "$MAIN_REPO_DIR" ]]; then
        PARSE_ERROR="Main repository not found: $MAIN_REPO_DIR"
        return $EXIT_NOT_FOUND
    fi
}

main() {
    local branch_name=""

    if ! load_env; then
        output_error "$EXIT_NOT_FOUND" "${PARSE_ERROR:-.env configuration error}"
        exit $EXIT_NOT_FOUND
    fi

    if ! parse_close_args "$@"; then
        output_error "$EXIT_INVALID_PARAMS" "${PARSE_ERROR:-Invalid parameters}"
        exit $EXIT_INVALID_PARAMS
    fi

    branch_name=$(generate_feature_branch_name "$BRANCH_NAME")

    if [[ ! -d "$WORKTREE_DIR" ]]; then
        output_error "$EXIT_NOT_FOUND" "Worktree not found: $WORKTREE_DIR"
        exit $EXIT_NOT_FOUND
    fi

    # Push the feature branch from the worktree
    if ! git_push_branch "$WORKTREE_DIR" "$branch_name"; then
        output_error "$EXIT_GIT_FAILED" "Failed to push branch: $branch_name" "" "$branch_name" "$WORKTREE_DIR"
        exit $EXIT_GIT_FAILED
    fi

    # Merge feature branch into target branch
    if ! git_merge_branch "$MAIN_REPO_DIR" "$branch_name" "$TARGET_BRANCH"; then
        output_error "$EXIT_GIT_FAILED" "Failed to merge $branch_name into $TARGET_BRANCH" "" "$branch_name" "$WORKTREE_DIR"
        exit $EXIT_GIT_FAILED
    fi

    # Remove the worktree
    if ! git_remove_worktree "$MAIN_REPO_DIR" "$WORKTREE_DIR"; then
        output_error "$EXIT_GIT_FAILED" "Failed to remove worktree: $WORKTREE_DIR" "" "$branch_name" "$WORKTREE_DIR"
        exit $EXIT_GIT_FAILED
    fi

    jq -n \
        --arg status "success" \
        --arg branch_name "$branch_name" \
        --arg target_branch "$TARGET_BRANCH" \
        --arg working_dir "$WORKTREE_DIR" \
        '{
            status: $status,
            branch_name: $branch_name,
            target_branch: $target_branch,
            merged: true,
            working_dir: $working_dir
        }'
}

main "$@"
